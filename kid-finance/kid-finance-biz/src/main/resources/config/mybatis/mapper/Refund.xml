<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xyzq.kid.finance.dao.po.RefundPO">
    <select id="selectByOrderNo" resultType="RefundPO">
SELECT *
FROM FIN_Refund
WHERE Deleted = 0 AND OrderNo = #{orderNo}
ORDER BY ID DESC
    </select>
    <select id="loadByRefundNo" resultType="RefundPO">
SELECT *
FROM FIN_Refund
WHERE Deleted = 0 AND RefundNo = #{refundNo}
ORDER BY ID DESC
LIMIT 1
    </select>
    <insert id="insertRefund" parameterType="RefundPO">
INSERT INTO FIN_Refund (RefundNo, OrderNo, RefundFee, Reason, RefundID, State, Deleted, CreateTime, UpdateTime)
VALUES (#{refundNo}, #{orderNo}, #{refundFee}, #{reason}, NULL, 0, 0, NOW(), NOW())
    </insert>
    <update id="updateRefunding">
UPDATE FIN_Refund
SET RefundID = #{refundId}, State = 1, UpdateTime = NOW()
WHERE RefundNo = #{refundNo} AND State = 0 AND Deleted = 0
    </update>
    <update id="updateRefundState">
UPDATE FIN_Refund
SET State = #{state}, RefundTime = #{refundTime}, UpdateTime = NOW()
WHERE RefundNo = #{refundNo} AND State = 1 AND Deleted = 0
    </update>
    <select id="select" resultType="OrderInfoPO">
SELECT R.*, O.Fee, U.MobileNo FROM
(
SELECT *
FROM FIN_Refund
WHERE Deleted = 0
<if test="orderNo != null and orderNo != ''">
    AND OrderNo = #{orderNo}
</if>
<if test="openId != null and openId != ''">
    AND OpenID = #{openId}
</if>
<if test="status != null and status == 1">
    AND (State = 0 OR State = 1)
</if>
<if test="status != null and status == 2">
    AND State = 2
</if>
<if test="status != null and status == 3">
    AND State = 3
</if>
<if test="beginTime != null">
    <![CDATA[
AND CreateTime >= beginTime
    ]]>
</if>
<if test="endTime != null">
    <![CDATA[
AND CreateTime <= endTime
    ]]>
</if>
) R
LEFT JOIN FIN_Order O
ON R.OrderNo = O.OrderNo AND R.Deleted = 0 AND O.Deleted = 0
LEFT JOIN LGC_User U
ON O.OpenID = U.OpenID AND U.Deleted = 0
ORDER BY ID DESC
LIMIT #{begin}, #{size}
    </select>
</mapper>
